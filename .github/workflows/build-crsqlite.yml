name: Build cr-sqlite Native Libraries

on:
  workflow_dispatch:
    inputs:
      crsqlite_version:
        description: 'cr-sqlite version/tag to build'
        required: false
        default: 'main'
  push:
    branches: [main]
    paths:
      - 'mobile/**'
      - '.github/workflows/build-crsqlite.yml'
  pull_request:
    branches: [main]
    paths:
      - 'mobile/**'
      - '.github/workflows/build-crsqlite.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CRSQLITE_VERSION: ${{ github.event.inputs.crsqlite_version || 'main' }}

jobs:
  build-android:
    name: Build Android (${{ matrix.target }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-linux-android
            abi: arm64-v8a
          - target: armv7-linux-androideabi
            abi: armeabi-v7a
          - target: x86_64-linux-android
            abi: x86_64
          - target: i686-linux-android
            abi: x86

    steps:
      - name: Checkout Le Stash
        uses: actions/checkout@v6

      - name: Checkout cr-sqlite
        uses: actions/checkout@v6
        with:
          repository: vlcn-io/cr-sqlite
          ref: ${{ env.CRSQLITE_VERSION }}
          path: cr-sqlite

      - name: Set up Rust
        uses: dtolnay/rust-action@stable
        with:
          targets: ${{ matrix.target }}

      - name: Set up Android NDK
        uses: android-actions/setup-android@v3

      - name: Install cargo-ndk
        run: cargo install cargo-ndk

      - name: Build cr-sqlite for Android
        working-directory: cr-sqlite/core
        run: |
          cargo ndk -t ${{ matrix.target }} build --release

      - name: Copy library
        run: |
          mkdir -p output/${{ matrix.abi }}
          cp cr-sqlite/target/${{ matrix.target }}/release/libcrsqlite.so output/${{ matrix.abi }}/

      - name: Upload Android artifact
        uses: actions/upload-artifact@v6
        with:
          name: crsqlite-android-${{ matrix.abi }}
          path: output/${{ matrix.abi }}/
          retention-days: 30

  build-ios:
    name: Build iOS
    runs-on: macos-latest
    steps:
      - name: Checkout Le Stash
        uses: actions/checkout@v6

      - name: Checkout cr-sqlite
        uses: actions/checkout@v6
        with:
          repository: vlcn-io/cr-sqlite
          ref: ${{ env.CRSQLITE_VERSION }}
          path: cr-sqlite

      - name: Set up Rust
        uses: dtolnay/rust-action@stable
        with:
          targets: aarch64-apple-ios,aarch64-apple-ios-sim,x86_64-apple-ios

      - name: Build cr-sqlite for iOS Device (arm64)
        working-directory: cr-sqlite/core
        run: cargo build --release --target aarch64-apple-ios

      - name: Build cr-sqlite for iOS Simulator (arm64)
        working-directory: cr-sqlite/core
        run: cargo build --release --target aarch64-apple-ios-sim

      - name: Build cr-sqlite for iOS Simulator (x86_64)
        working-directory: cr-sqlite/core
        run: cargo build --release --target x86_64-apple-ios

      - name: Create universal simulator library
        run: |
          mkdir -p output/ios-simulator
          lipo -create \
            cr-sqlite/target/aarch64-apple-ios-sim/release/libcrsqlite.a \
            cr-sqlite/target/x86_64-apple-ios/release/libcrsqlite.a \
            -output output/ios-simulator/libcrsqlite.a

      - name: Create XCFramework
        run: |
          mkdir -p output/xcframework
          xcodebuild -create-xcframework \
            -library cr-sqlite/target/aarch64-apple-ios/release/libcrsqlite.a \
            -library output/ios-simulator/libcrsqlite.a \
            -output output/xcframework/crsqlite.xcframework

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v6
        with:
          name: crsqlite-ios-xcframework
          path: output/xcframework/
          retention-days: 30

  package:
    name: Package All Libraries
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts

      - name: Package Android libraries
        run: |
          mkdir -p package/android
          for abi in arm64-v8a armeabi-v7a x86_64 x86; do
            if [ -d "artifacts/crsqlite-android-$abi" ]; then
              cp -r artifacts/crsqlite-android-$abi/* package/android/
              mkdir -p package/android/$abi
              mv package/android/libcrsqlite.so package/android/$abi/ 2>/dev/null || true
            fi
          done

      - name: Package iOS libraries
        run: |
          mkdir -p package/ios
          if [ -d "artifacts/crsqlite-ios-xcframework" ]; then
            cp -r artifacts/crsqlite-ios-xcframework/* package/ios/
          fi

      - name: Create combined archive
        run: |
          cd package
          tar -czvf ../crsqlite-mobile-libraries.tar.gz .

      - name: Upload combined package
        uses: actions/upload-artifact@v6
        with:
          name: crsqlite-mobile-libraries
          path: crsqlite-mobile-libraries.tar.gz
          retention-days: 90

      - name: Upload to release (if tagged)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: crsqlite-mobile-libraries.tar.gz
